<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <title>ytjohn</title>
    <meta name="description" content="">
    <meta name="author" content="John Hogenmiller">

    <!-- Le styles -->
    <link href="http://www.yourtech.us/theme/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
      body {
      padding-top: 60px;
      padding-bottom: 40px;
      }
      .sidebar-nav {
      padding: 9px 0;
      }
    </style>
    <link href="http://www.yourtech.us/theme/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="http://www.yourtech.us/theme/local.css" rel="stylesheet">
    <link href="http://www.yourtech.us/theme/pygments.css" rel="stylesheet">



<script type="text/javascript">
  var disqus_shortname = "yourtechjohn"; // required: replace example with your forum shortname
  var disqus_developer = 1;
  
  var disqus_identifier = "/2012/08/gate-one-supervisor-script.html";
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();

  (function () {
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>
  </head>
  <body>
<!--[if lt IE 7]><p class=chromeframe>Your browser is <em>ancient!</em> <a href="http://browsehappy.com/">Upgrade to a different browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to experience this site.</p><![endif]-->
    
<div class="navbar navbar-inverse navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container-fluid">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
	<span class="icon-bar"></span>
	<span class="icon-bar"></span>
	<span class="icon-bar"></span>
      </a>
      <a class="brand" href="http://www.yourtech.us/index.html">ytjohn</a> 
      <div class="nav-collapse collapse">
	<ul class="nav">
 
	  <li ><a href="http://www.yourtech.us/p/contact.html">Contact</a></li>
 
	  <li ><a href="http://www.yourtech.us/p/resume.html">Resume</a></li>
 
	  <li ><a href="http://www.yourtech.us/p/the-story.html">The Story</a></li>
	  <li class="active"><a href="http://www.yourtech.us/category/posts.html">posts</a></li>
	</ul>
	<p class="navbar-text pull-right">
	  <a class="navbar-link" href="http://www.yourtech.us/archives.html">[archives]</a>
    <a class="navbar-link" href="http://www.yourtech.us/tags.html">[tags]</a>
     :: <a style="color: red;" href="https://hub.yourtech.us/billing/">Billing</a> 
     :: <a style="color: red;" href="https://hub.yourtech.us/dnsadmin/">DNS Admin</a> 
	</p>
      </div><!--/.nav-collapse -->
    </div>
  </div>
</div>
    <div class="container-fluid">
      <div class="row-fluid">
	<div class="span1">&nbsp;</div>
	<div class="span10">
	  <div class="row-fluid">
            <div class="span9">
<div class='article'>
  <div class="page-header"><h1>Gate One supervisor script</h1></div>
  <div class="well small"><a class="more" href="http://www.yourtech.us//2012/08/gate-one-supervisor-script.html">On 02 Aug 2012 at 0710</a>
by <a class="url fn" href="http://www.yourtech.us/author/john-hogenmiller.html">John Hogenmiller</a> 
in <a href="http://www.yourtech.us/category/posts.html">posts</a> 
 | <a href="http://www.yourtech.us/2012/08/gate-one-supervisor-script.text">{source}</a>
 | <a href="http://www.yourtech.us//2012/08/gate-one-supervisor-script.html#disqus_thread">Comments</a></div>
  <div><p>Yesterday, I <a href="http://blog.yourtech.us/2012/08/exploring-gateone-browser-ssh-terminal.html">setup gateone</a> to run as a non-root user. I also spent
some time looking at potential init scripts for starting and stopping
this. The gateone project does not currently provide any init scripts,
but this is planned for the future ([Issue #47]). I tried to use one
of the scripts in that thread, but I wasn't really pleased with them.
The big issue is that gateone.py doesn't fork. However, I believe there
is a better solution.</p>
<p><a href="http://www.supervisord.org/">supervisord</a> is a python script designed to control and monitor
non-daemonizing python scripts. As Gate One is a foreground only
process, it seems particularly suited to this task - more so than
writing my own script in python or daemontools.</p>
<p>Installation can be done with python-pip or easy_install. On newer
systems, pip is recommended.</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">supervisor</span>
</pre></div>


<p>On Ubuntu, pip installs supervisord to /usr/local/bin. By default,
/usr/local/bin is not in root's path, so it makes sense (to me at least)
to create symlinks to /usr/sbin.</p>
<div class="highlight"><pre><span class="n">johnh</span><span class="err">@</span><span class="n">puppet2</span><span class="o">:~</span><span class="err">$</span> <span class="n">ls</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span>
<span class="n">echo_supervisord_conf</span>  <span class="n">pidproxy</span>  <span class="n">supervisorctl</span>  
<span class="n">supervisordjohnh</span><span class="err">@</span><span class="n">puppet2</span><span class="o">:~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">supervisord</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span>
<span class="n">johnh</span><span class="err">@</span><span class="n">puppet2</span><span class="o">:~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">supervisorctl</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span>
</pre></div>


<p>Now, we need to create a configuration file. Supervisord has a utility
to generate a sample one.</p>
<div class="highlight"><pre><span class="n">echo_supervisord_conf</span>  <span class="o">&gt;</span> <span class="n">supervisord</span><span class="p">.</span><span class="n">conf</span>
</pre></div>


<p>To get started, we can use the sample configuration and just add a
couple lines to the bottom for gateone.</p>
<div class="highlight"><pre> <span class="p">[</span><span class="n">program</span><span class="o">:</span><span class="n">gateone</span><span class="p">]</span>
 <span class="n">command</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">gateone</span><span class="o">/</span><span class="n">gateone</span><span class="p">.</span><span class="n">py</span>
 <span class="n">directory</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">gateone</span>
 <span class="p">;</span><span class="n">user</span><span class="o">=</span><span class="n">johnh</span>   <span class="p">;</span> <span class="n">Default</span> <span class="n">is</span> <span class="n">root</span><span class="p">.</span> <span class="n">Add</span> <span class="n">a</span> <span class="n">user</span><span class="o">=</span> <span class="n">to</span> <span class="n">setuid</span>
</pre></div>


<p>Now, copy supervisord.conf to /etc/supervisord.conf and start
supervisord. Make sure gateone.py is not currently running. Then we'll
run supervisorctl to test things out.</p>
<div class="highlight"><pre><span class="n">johnh</span><span class="err">@</span><span class="n">puppet2</span><span class="o">:~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">cp</span> <span class="n">supervisord</span><span class="p">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span>
<span class="n">johnh</span><span class="err">@</span><span class="n">puppet2</span><span class="o">:~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">supervisord</span>
<span class="n">johnh</span><span class="err">@</span><span class="n">puppet2</span><span class="o">:~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">supervisorctl</span> <span class="n">status</span>
<span class="n">gateone</span>                          <span class="n">RUNNING</span>    <span class="n">pid</span> <span class="mi">9549</span><span class="p">,</span> <span class="n">uptime</span> <span class="mi">0</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">05</span>
<span class="n">johnh</span><span class="err">@</span><span class="n">puppet2</span><span class="o">:~</span><span class="err">$</span> <span class="n">ps</span> <span class="n">ax</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">gateone</span>
 <span class="mi">9549</span> <span class="o">?</span>        <span class="n">Sl</span>     <span class="mi">0</span><span class="o">:</span><span class="mo">00</span> <span class="n">python</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">gateone</span><span class="o">/</span><span class="n">gateone</span><span class="p">.</span><span class="n">py</span>
<span class="n">johnh</span><span class="err">@</span><span class="n">puppet2</span><span class="o">:~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">supervisorctl</span> <span class="n">stop</span> <span class="n">gateone</span>
<span class="nl">gateone:</span> <span class="n">stopped</span>
<span class="n">johnh</span><span class="err">@</span><span class="n">puppet2</span><span class="o">:~</span><span class="err">$</span> <span class="n">ps</span> <span class="n">ax</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">gateone</span>
 <span class="mi">9605</span> <span class="o">?</span>        <span class="n">Ss</span>     <span class="mi">0</span><span class="o">:</span><span class="mo">00</span> <span class="n">dtach</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">gateone</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">gateone</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">dtach_3</span> <span class="o">-</span><span class="n">E</span> <span class="o">-</span><span class="n">z</span> <span class="o">-</span><span class="n">r</span> <span class="n">none</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">gateone</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">ssh_connect</span><span class="p">.</span><span class="n">py</span> <span class="o">-</span><span class="n">S</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">gateone</span><span class="o">/</span><span class="p">...</span><span class="o">/%</span><span class="n">SHORT_SOCKET</span><span class="o">%</span> <span class="o">--</span><span class="n">sshfp</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">oUserKnownHostsFile</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">gateone</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">user1</span><span class="err">@</span><span class="n">puppet2</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">known_hosts</span>
 <span class="mi">9606</span> <span class="n">pts</span><span class="o">/</span><span class="mi">3</span>    <span class="n">Ss</span><span class="o">+</span>    <span class="mi">0</span><span class="o">:</span><span class="mo">00</span> <span class="n">python</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">gateone</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">ssh_connect</span><span class="p">.</span><span class="n">py</span> <span class="o">-</span><span class="n">S</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">gateone</span><span class="o">/</span><span class="p">...</span><span class="o">/%</span><span class="n">SHORT_SOCKET</span><span class="o">%</span> <span class="o">--</span><span class="n">sshfp</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">oUserKnownHostsFile</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">gateone</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">user1</span><span class="err">@</span><span class="n">puppet2</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">known_hosts</span>
</pre></div>


<p>In this example, we see that gateone.py is started and stopped by
supervisorctl, but because we have dtach enabled, our sessions are still
in place. If we restart gateone.py, we can connect to it again and have
our sessions resumed. While we could probably configure supervisord to
kill these terminals, I believe we'd normally want to keep them running.
The few times I would want to stop those terminals would be a) manually
reconfiguring/troubleshooting opengate, b) updating software, or c)
rebooting the server. For a&amp;b, running the command "gateone.py -kill"
will kill those terminals. For a server shutdown or reboot, the act of
shutting down the OS will kill these terminals.</p>
<p>Finally, we need a way to start and stop supervisord itself.
Fortunately, the supervisord project has provided a number of <a href="https://github.com/Supervisor/initscripts">init
scripts</a>. I was able to use the <a href="https://raw.github.com/Supervisor/initscripts/master/debian-norrgard">Debian script</a> in Ubuntu with only
a few minor changes.</p>
<ol>
<li>I had symlinked supervisord and supervisorctl to /usr/sbin. The
    script expects them in /usr/bin (but even says that /usr/sbin is a
    better location). I had to change /usr/bin to /usr/sbin.
    Alternatively, you can symlink the files into /usr/bin</li>
<li>I added a status option that runs \$SUPERVISORCTL status</li>
<li>If you started supervisord manually, you must shut it down and start
    it with the script. The script won't be able to stop supervisord
    unless /var/run/supervisord.pid is current.</li>
</ol>
<p>Here is my complete init script for Ubuntu:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/bin/sh</span>
<span class="c">### BEGIN INIT INFO</span>
<span class="c"># Provides:          supervisord</span>
<span class="c"># Required-Start:    $local_fs $remote_fs $networking</span>
<span class="c"># Required-Stop:     $local_fs $remote_fs $networking</span>
<span class="c"># Default-Start:     2 3 4 5</span>
<span class="c"># Default-Stop:      0 1 6</span>
<span class="c"># Short-Description: Starts supervisord - see http://supervisord.org</span>
<span class="c"># Description:       Starts and stops supervisord as needed </span>
<span class="c">### END INIT INFO</span>
<span class="c"># Author: Leonard Norrgard </span>
<span class="c"># Version 1.0-alpha</span>
<span class="c"># Based on the /etc/init.d/skeleton script in Debian.</span>
<span class="c"># Please note: This script is not yet well tested. What little testing</span>
<span class="c"># that actually was done was only on supervisor 2.2b1.</span>
<span class="c"># Do NOT &quot;set -e&quot;</span>
<span class="c"># PATH should only include /usr/* if it runs after the mountnfs.sh script</span>
<span class="nv">PATH</span><span class="o">=</span>/sbin:/usr/sbin:/bin:/usr/bin
<span class="nv">DESC</span><span class="o">=</span><span class="s2">&quot;Run a set of applications as daemons.&quot;</span>
<span class="nv">NAME</span><span class="o">=</span>supervisord
<span class="c"># Supervisord is installed in /usr/bin by default, but /usr/sbin would </span>
<span class="c"># make more sense</span>
<span class="nv">DAEMON</span><span class="o">=</span>/usr/sbin/<span class="nv">$NAME</span>   
<span class="nv">SUPERVISORCTL</span><span class="o">=</span>/usr/sbin/supervisorctl
<span class="nv">PIDFILE</span><span class="o">=</span>/var/run/<span class="nv">$NAME</span>.pid
<span class="nv">DAEMON_ARGS</span><span class="o">=</span><span class="s2">&quot;--pidfile ${PIDFILE}&quot;</span>
<span class="nv">SCRIPTNAME</span><span class="o">=</span>/etc/init.d/<span class="nv">$NAME</span>
<span class="c"># Exit if the package is not installed</span>
<span class="o">[</span> -x <span class="s2">&quot;$DAEMON&quot;</span> <span class="o">]</span> <span class="o">||</span> <span class="nb">exit </span>0
<span class="c"># Read configuration variable file if it is present</span>
<span class="o">[</span> -r /etc/default/<span class="nv">$NAME</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> . /etc/default/<span class="nv">$NAME</span>
<span class="c"># Load the VERBOSE setting and other rcS variables</span>
. /lib/init/vars.sh
<span class="c"># Define LSB log_* functions.</span>
<span class="c"># Depend on lsb-base (&gt;= 3.0-6) to ensure that this file is present.</span>
. /lib/lsb/init-functions
<span class="c">#</span>
<span class="c"># Function that starts the daemon/service</span>
<span class="c">#</span>
do_start<span class="o">()</span>
<span class="o">{</span>
        <span class="c"># Return</span>
        <span class="c">#   0 if daemon has been started</span>
        <span class="c">#   1 if daemon was already running</span>
        <span class="c">#   2 if daemon could not be started</span>
        <span class="o">[</span> -e <span class="nv">$PIDFILE</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>1
        start-stop-daemon --start --quiet --pidfile <span class="nv">$PIDFILE</span> --exec <span class="nv">$DAEMON</span> -- <span class="se">\</span>
                <span class="nv">$DAEMON_ARGS</span>  <span class="se">\</span>
                <span class="o">||</span> <span class="k">return </span>2
        <span class="c"># Add code here, if necessary, that waits for the process to be ready</span>
        <span class="c"># to handle requests from services started subsequently which depend</span>
        <span class="c"># on this one.  As a last resort, sleep for some time.</span>
<span class="o">}</span>
<span class="c">#</span>
<span class="c"># Function that stops the daemon/service</span>
<span class="c">#</span>
do_stop<span class="o">()</span>
<span class="o">{</span>
        <span class="c"># Return</span>
        <span class="c">#   0 if daemon has been stopped</span>
        <span class="c">#   1 if daemon was already stopped</span>
        <span class="c">#   2 if daemon could not be stopped</span>
        <span class="c">#   other if a failure occurred</span>
        <span class="o">[</span> -e <span class="nv">$PIDFILE</span> <span class="o">]</span> <span class="o">||</span> <span class="k">return </span>1
        <span class="c"># Stop all processes under supervisord control.</span>
        <span class="nv">$SUPERVISORCTL</span> stop all
        start-stop-daemon --stop --quiet --retry<span class="o">=</span>TERM/30/KILL/5 --pidfile <span class="nv">$PIDFILE</span> <span class="se">\ </span>
             --name <span class="nv">$NAME</span>
        <span class="nv">RETVAL</span><span class="o">=</span><span class="s2">&quot;$?&quot;</span>
        <span class="o">[</span> <span class="s2">&quot;$RETVAL&quot;</span> <span class="o">=</span> 2 <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>2
        <span class="c"># Wait for children to finish too if this is a daemon that forks</span>
        <span class="c"># and if the daemon is only ever run from this initscript.</span>
        <span class="c"># If the above conditions are not satisfied then add some other code</span>
        <span class="c"># that waits for the process to drop all resources that could be</span>
        <span class="c"># needed by services started subsequently.  A last resort is to</span>
        <span class="c"># sleep for some time.</span>
        start-stop-daemon --stop --quiet --oknodo --retry<span class="o">=</span>0/30/KILL/5 --exec <span class="nv">$DAEMON</span>
        <span class="o">[</span> <span class="s2">&quot;$?&quot;</span> <span class="o">=</span> 2 <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>2
        <span class="c"># Many daemons don&#39;t delete their pidfiles when they exit.</span>
        rm -f <span class="nv">$PIDFILE</span>
        <span class="k">return</span> <span class="s2">&quot;$RETVAL&quot;</span>
<span class="o">}</span>
<span class="c">#</span>
<span class="c"># Function that sends a SIGHUP to the daemon/service</span>
<span class="c">#</span>
do_reload<span class="o">()</span> <span class="o">{</span>
        <span class="c">#</span>
        <span class="c"># If the daemon can reload its configuration without</span>
        <span class="c"># restarting (for example, when it is sent a SIGHUP),</span>
        <span class="c"># then implement that here.</span>
        <span class="c">#</span>
        start-stop-daemon --stop --signal 1 --quiet --pidfile <span class="nv">$PIDFILE</span> --name <span class="nv">$NAME</span>
        <span class="k">return </span>0
<span class="o">}</span>
<span class="k">case</span> <span class="s2">&quot;$1&quot;</span> in
  start<span class="o">)</span>
        <span class="o">[</span> <span class="s2">&quot;$VERBOSE&quot;</span> !<span class="o">=</span> no <span class="o">]</span> <span class="o">&amp;&amp;</span> log_daemon_msg <span class="s2">&quot;Starting $DESC&quot;</span> <span class="s2">&quot;$NAME&quot;</span>
        do_start
        <span class="k">case</span> <span class="s2">&quot;$?&quot;</span> in
                0|1<span class="o">)</span> <span class="o">[</span> <span class="s2">&quot;$VERBOSE&quot;</span> !<span class="o">=</span> no <span class="o">]</span> <span class="o">&amp;&amp;</span> log_end_msg 0 ;;
                2<span class="o">)</span> <span class="o">[</span> <span class="s2">&quot;$VERBOSE&quot;</span> !<span class="o">=</span> no <span class="o">]</span> <span class="o">&amp;&amp;</span> log_end_msg 1 ;;
        <span class="k">esac</span>
        ;;
  stop<span class="o">)</span>
        <span class="o">[</span> <span class="s2">&quot;$VERBOSE&quot;</span> !<span class="o">=</span> no <span class="o">]</span> <span class="o">&amp;&amp;</span> log_daemon_msg <span class="s2">&quot;Stopping $DESC&quot;</span> <span class="s2">&quot;$NAME&quot;</span>
        do_stop
        <span class="k">case</span> <span class="s2">&quot;$?&quot;</span> in
                0|1<span class="o">)</span> <span class="o">[</span> <span class="s2">&quot;$VERBOSE&quot;</span> !<span class="o">=</span> no <span class="o">]</span> <span class="o">&amp;&amp;</span> log_end_msg 0 ;;
                2<span class="o">)</span> <span class="o">[</span> <span class="s2">&quot;$VERBOSE&quot;</span> !<span class="o">=</span> no <span class="o">]</span> <span class="o">&amp;&amp;</span> log_end_msg 1 ;;
        <span class="k">esac</span>
        ;;
  <span class="c">#reload|force-reload)</span>
        <span class="c">#</span>
        <span class="c"># If do_reload() is not implemented then leave this commented out</span>
        <span class="c"># and leave &#39;force-reload&#39; as an alias for &#39;restart&#39;.</span>
        <span class="c">#</span>
        <span class="c">#log_daemon_msg &quot;Reloading $DESC&quot; &quot;$NAME&quot;</span>
        <span class="c">#do_reload</span>
        <span class="c">#log_end_msg $?</span>
        <span class="c">#;;</span>
  restart|force-reload<span class="o">)</span>
        <span class="c">#</span>
        <span class="c"># If the &quot;reload&quot; option is implemented then remove the</span>
        <span class="c"># &#39;force-reload&#39; alias</span>
        <span class="c">#</span>
        log_daemon_msg <span class="s2">&quot;Restarting $DESC&quot;</span> <span class="s2">&quot;$NAME&quot;</span>
        do_stop
        <span class="k">case</span> <span class="s2">&quot;$?&quot;</span> in
          0|1<span class="o">)</span>
                do_start
                <span class="k">case</span> <span class="s2">&quot;$?&quot;</span> in
                        0<span class="o">)</span> log_end_msg 0 ;;
                        1<span class="o">)</span> log_end_msg 1 ;; <span class="c"># Old process is still running</span>
                        *<span class="o">)</span> log_end_msg 1 ;; <span class="c"># Failed to start</span>
                <span class="k">esac</span>
                ;;
          *<span class="o">)</span>
                <span class="c"># Failed to stop</span>
                log_end_msg 1
                ;;
        <span class="k">esac</span>
        ;;
  status<span class="o">)</span>
        <span class="nv">$SUPERVISORCTL</span> status
        <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
        ;;
  *<span class="o">)</span>
        <span class="c">#echo &quot;Usage: $SCRIPTNAME {start|stop|restart|reload|force-reload}&quot; &gt;&amp;2</span>
        <span class="nb">echo</span> <span class="s2">&quot;Usage: $SCRIPTNAME {start|stop|restart|force-reload|status}&quot;</span> &gt;&amp;2
        <span class="nb">exit </span>3
        ;;
<span class="k">esac</span>
</pre></div>
</td></tr></table>

<p>And here is a complete copy of my supervisord.conf file:</p>
<div class="highlight"><pre><span class="k">[unix_http_server]</span>
<span class="na">file</span><span class="o">=</span><span class="s">/tmp/supervisor.sock   ; (the path to the socket file)</span>
<span class="k">[supervisord]</span>
<span class="na">logfile</span><span class="o">=</span><span class="s">/tmp/supervisord.log ; (main log file;default $CWD/supervisord.log)</span>
<span class="na">logfile_maxbytes</span><span class="o">=</span><span class="s">50MB        ; (max main logfile bytes b4 rotation;default 50MB)</span>
<span class="na">logfile_backups</span><span class="o">=</span><span class="s">10           ; (num of main logfile rotation backups;default 10)</span>
<span class="na">loglevel</span><span class="o">=</span><span class="s">info                ; (log level;default info; others: debug,warn,trace)</span>
<span class="na">pidfile</span><span class="o">=</span><span class="s">/tmp/supervisord.pid ; (supervisord pidfile;default supervisord.pid)</span>
<span class="na">nodaemon</span><span class="o">=</span><span class="s">false               ; (start in foreground if true;default false)</span>
<span class="na">minfds</span><span class="o">=</span><span class="s">1024                  ; (min. avail startup file descriptors;default 1024)</span>
<span class="na">minprocs</span><span class="o">=</span><span class="s">200                 ; (min. avail process descriptors;default 200)</span>
<span class="k">[rpcinterface:supervisor]</span>
<span class="na">supervisor.rpcinterface_factory</span> <span class="o">=</span> <span class="s">supervisor.rpcinterface:make_main_rpcinterface</span>
<span class="k">[supervisorctl]</span>
<span class="na">serverurl</span><span class="o">=</span><span class="s">unix:///tmp/supervisor.sock ; use a unix:// URL  for a unix socket</span>
<span class="k">[program:gateone]</span>
<span class="na">command</span><span class="o">=</span><span class="s">/opt/gateone/gateone.py</span>
<span class="na">directory</span><span class="o">=</span><span class="s">/opt/gateone</span>
<span class="na">stdout_logfile</span><span class="o">=</span><span class="s">/opt/gateone/logs/supervisor.log</span>
<span class="na">user</span><span class="o">=</span><span class="s">johnh</span>
</pre></div></div>
  <div>
    <h2>Comments</h2>
    <div id="disqus_thread"></div>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</div>	
            </div><!--/span-->

	    <div class="span3">




<div class="well sidebar-nav">
  <ul class="nav nav-list">
    <li> <div id="search">
<script>
  (function() {
    var cx = '008176316909509740226:1osf0ptylds';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div> </li>
  </ul>

  <ul class="nav nav-list social">
    <li class="nav-header">Elsewhere</li>
    <li><a href="//www.yourtech.us/gh">GitHub/ytjohn</a></li>
    <li><a href="//www.yourtech.us/plus">My Google+</a></li>
  </ul>

  <ul class="nav nav-list">
    <li class="nav-header">Links</li>
    <li><a href="https://hub.yourtech.us/billing">YourTech::Billing</a></li>
    <li><a href="https://hub.yourtech.us/dnsadmin">YourTech::DNS</a></li>
    <li><a href="#">----------------</a></li>
    <li><a href="http://www.idgraphics.net">id Graphics</a></li>
    <li><a href="http://bcars.org">Bedford County Amateur Radio Society</a></li>
    <li><a href="http://www.everettpa.net">Everett, PA</a></li>
    <li><a href="http://www.raystownwireless.net">Raystown Wireless</a></li>
  </ul>

  <ul class="nav nav-list">
   <li> <h4><a href="/archives.html">Archives</a></h4>
<!-- bootstrap collapsible archive list -->
<div class="accordion" id="sidebararchive">
  <!-- year 2013 -->
  <div class="accordion-group">
    <div class="accordion-heading">
      <a class="accordion-toggle" data-toggle="collapse" data-parent="#sidebarchive" href="#collapse2013">
        2013
      </a>
    </div>

    <div id="collapse2013" class="accordion-body collapse">
         <div class="accordion-inner">

           <!-- now to collapse by month -->
            <a class="accorion-toggle" data-toggle="collapse" data-parent="collapse2013"
               href="#collapse2013July">
               July (1) 
            </a>
           <div id="collapse2013July" class="accordion-body collapse">
           <div class="accordion-inner">
                        <a href="/2013/07/foreman-managed-virtual-datacenter.html">Foreman managed virtual datacenter</a><br />
           </div>
           </div>
           <!-- end collapse by month -->
         </div>
         <div class="accordion-inner">

           <!-- now to collapse by month -->
            <a class="accorion-toggle" data-toggle="collapse" data-parent="collapse2013"
               href="#collapse2013March">
               March (1) 
            </a>
           <div id="collapse2013March" class="accordion-body collapse">
           <div class="accordion-inner">
                        <a href="/2013/03/new-static-site.html">New Static Site</a><br />
           </div>
           </div>
           <!-- end collapse by month -->
         </div>
    </div>
 </div>
  <!-- year 2012 -->
  <div class="accordion-group">
    <div class="accordion-heading">
      <a class="accordion-toggle" data-toggle="collapse" data-parent="#sidebarchive" href="#collapse2012">
        2012
      </a>
    </div>

    <div id="collapse2012" class="accordion-body collapse">
         <div class="accordion-inner">

           <!-- now to collapse by month -->
            <a class="accorion-toggle" data-toggle="collapse" data-parent="collapse2012"
               href="#collapse2012November">
               November (1) 
            </a>
           <div id="collapse2012November" class="accordion-body collapse">
           <div class="accordion-inner">
                        <a href="/2012/11/starting-with-ruby-and-aws.html">Starting with Ruby and AWS</a><br />
           </div>
           </div>
           <!-- end collapse by month -->
         </div>
         <div class="accordion-inner">

           <!-- now to collapse by month -->
            <a class="accorion-toggle" data-toggle="collapse" data-parent="collapse2012"
               href="#collapse2012September">
               September (2) 
            </a>
           <div id="collapse2012September" class="accordion-body collapse">
           <div class="accordion-inner">
                        <a href="/2012/09/dingus-problems.html">dingus problems</a><br />
                        <a href="/2012/09/bootstrap-and-cdns.html">Bootstrap and CDNs</a><br />
           </div>
           </div>
           <!-- end collapse by month -->
         </div>
         <div class="accordion-inner">

           <!-- now to collapse by month -->
            <a class="accorion-toggle" data-toggle="collapse" data-parent="collapse2012"
               href="#collapse2012August">
               August (6) 
            </a>
           <div id="collapse2012August" class="accordion-body collapse">
           <div class="accordion-inner">
                        <a href="/2012/08/python-console-import-tip.html">python console import tip</a><br />
                        <a href="/2012/08/pysphere-vmware-in-python.html">pysphere - VMWare in Python</a><br />
                        <a href="/2012/08/upgrade-redmine.html">Upgrade Redmine</a><br />
                        <a href="/2012/08/markdown-blogging.html">Markdown Blogging</a><br />
                        <a href="/2012/08/gate-one-supervisor-script.html">Gate One supervisor script</a><br />
                        <a href="/2012/08/exploring-gateone-browser-ssh-terminal.html">Exploring GateOne Browser SSH terminal</a><br />
           </div>
           </div>
           <!-- end collapse by month -->
         </div>
         <div class="accordion-inner">

           <!-- now to collapse by month -->
            <a class="accorion-toggle" data-toggle="collapse" data-parent="collapse2012"
               href="#collapse2012June">
               June (2) 
            </a>
           <div id="collapse2012June" class="accordion-body collapse">
           <div class="accordion-inner">
                        <a href="/2012/06/puppet-dashboard-and-selinux.html">Puppet Dashboard and selinux</a><br />
                        <a href="/2012/06/using-puppet-to-install-djbdns.html">Using puppet to install djbdns</a><br />
           </div>
           </div>
           <!-- end collapse by month -->
         </div>
    </div>
 </div>
  <!-- year 2011 -->
  <div class="accordion-group">
    <div class="accordion-heading">
      <a class="accordion-toggle" data-toggle="collapse" data-parent="#sidebarchive" href="#collapse2011">
        2011
      </a>
    </div>

    <div id="collapse2011" class="accordion-body collapse">
         <div class="accordion-inner">

           <!-- now to collapse by month -->
            <a class="accorion-toggle" data-toggle="collapse" data-parent="collapse2011"
               href="#collapse2011April">
               April (1) 
            </a>
           <div id="collapse2011April" class="accordion-body collapse">
           <div class="accordion-inner">
                        <a href="/2011/04/sending-messages-using-xmpppy.html">Sending messages using xmpppy</a><br />
           </div>
           </div>
           <!-- end collapse by month -->
         </div>
         <div class="accordion-inner">

           <!-- now to collapse by month -->
            <a class="accorion-toggle" data-toggle="collapse" data-parent="collapse2011"
               href="#collapse2011February">
               February (2) 
            </a>
           <div id="collapse2011February" class="accordion-body collapse">
           <div class="accordion-inner">
                        <a href="/2011/02/nagios-and-xmpp.html">Nagios and XMPP</a><br />
                        <a href="/2011/02/jabbering-about-python.html">Jabbering about Python</a><br />
           </div>
           </div>
           <!-- end collapse by month -->
         </div>
         <div class="accordion-inner">

           <!-- now to collapse by month -->
            <a class="accorion-toggle" data-toggle="collapse" data-parent="collapse2011"
               href="#collapse2011January">
               January (2) 
            </a>
           <div id="collapse2011January" class="accordion-body collapse">
           <div class="accordion-inner">
                        <a href="/2011/01/expanding-a-raw-image-file.html">Expanding a raw image file</a><br />
                        <a href="/2011/01/learning-python.html">Learning Python</a><br />
           </div>
           </div>
           <!-- end collapse by month -->
         </div>
    </div>
 </div>
  <!-- year 2010 -->
  <div class="accordion-group">
    <div class="accordion-heading">
      <a class="accordion-toggle" data-toggle="collapse" data-parent="#sidebarchive" href="#collapse2010">
        2010
      </a>
    </div>

    <div id="collapse2010" class="accordion-body collapse">
         <div class="accordion-inner">

           <!-- now to collapse by month -->
            <a class="accorion-toggle" data-toggle="collapse" data-parent="collapse2010"
               href="#collapse2010September">
               September (1) 
            </a>
           <div id="collapse2010September" class="accordion-body collapse">
           <div class="accordion-inner">
                        <a href="/2010/09/we-have-moved.html">We have moved!</a><br />
           </div>
           </div>
           <!-- end collapse by month -->
         </div>
         <div class="accordion-inner">

           <!-- now to collapse by month -->
            <a class="accorion-toggle" data-toggle="collapse" data-parent="collapse2010"
               href="#collapse2010January">
               January (1) 
            </a>
           <div id="collapse2010January" class="accordion-body collapse">
           <div class="accordion-inner">
                        <a href="/2010/01/securing-apache2.html">Securing Apache2</a><br />
           </div>
           </div>
           <!-- end collapse by month -->
         </div>
    </div>
 </div>
  <!-- year 2009 -->
  <div class="accordion-group">
    <div class="accordion-heading">
      <a class="accordion-toggle" data-toggle="collapse" data-parent="#sidebarchive" href="#collapse2009">
        2009
      </a>
    </div>

    <div id="collapse2009" class="accordion-body collapse">
         <div class="accordion-inner">

           <!-- now to collapse by month -->
            <a class="accorion-toggle" data-toggle="collapse" data-parent="collapse2009"
               href="#collapse2009October">
               October (1) 
            </a>
           <div id="collapse2009October" class="accordion-body collapse">
           <div class="accordion-inner">
                        <a href="/2009/10/backing-up-with-duplicity-and-amazon-s3.html">Backing up with duplicity and Amazon S3</a><br />
           </div>
           </div>
           <!-- end collapse by month -->
         </div>
         <div class="accordion-inner">

           <!-- now to collapse by month -->
            <a class="accorion-toggle" data-toggle="collapse" data-parent="collapse2009"
               href="#collapse2009September">
               September (1) 
            </a>
           <div id="collapse2009September" class="accordion-body collapse">
           <div class="accordion-inner">
                        <a href="/2009/09/forgotten-realms.html">Forgotten Realms</a><br />
           </div>
           </div>
           <!-- end collapse by month -->
         </div>
         <div class="accordion-inner">

           <!-- now to collapse by month -->
            <a class="accorion-toggle" data-toggle="collapse" data-parent="collapse2009"
               href="#collapse2009August">
               August (1) 
            </a>
           <div id="collapse2009August" class="accordion-body collapse">
           <div class="accordion-inner">
                        <a href="/2009/08/back-into-programming-monitoring-notes.html">Back into programming, monitoring notes</a><br />
           </div>
           </div>
           <!-- end collapse by month -->
         </div>
    </div>
 </div>
</div>
 </li>
  </ul>

</div><!--/.well -->
            </div><!--/span-->

	  </div>
	</div>
      </div><!--/row-->

      <hr>

      <footer>
        <p>Powered by <a href="http://alexis.notmyidea.org/pelican/">Pelican</a></p>
	<p>&copy; John Hogenmiller 2012</p>
      </footer>

    </div><!--/.fluid-container-->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="http://www.yourtech.us/theme/js/jquery-1.7.2.min.js"><\/script>')</script>
      <script src="http://www.yourtech.us/theme/bootstrap/js/bootstrap.min.js"></script>
      <script src="http://www.yourtech.us/theme/js/modernizr-2.5.3-respond-1.1.0.min.js"></script>

  </body>
</html>